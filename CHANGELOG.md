# 更新日志

## 最新更新 - 奖池管理和提取功能

### 新增功能

1. **奖池管理**
   - 添加了 `prizePool` 变量跟踪当前奖池总额
   - 添加了 `totalInvested` 变量跟踪所有玩家的总投入
   - 购买道具时，资金自动存入奖池

2. **奖金分配系统**
   - 游戏结束后，自动分配奖金给前三名
   - 分配比例：
     - 🥇 第一名：50%
     - 🥈 第二名：30%
     - 🥉 第三名：20%
   - 奖金直接存入玩家的 `rewardBalance` 余额

3. **玩家奖金跟踪**
   - 每个玩家现在有 `rewardBalance` 字段跟踪可提取的奖金
   - 奖金在游戏结束后自动分配，无需手动操作

4. **提取功能**
   - 玩家可以随时提取自己的奖金余额
   - 提取操作码：`0x77647277` ("wdrw")
   - 提取后，玩家的奖金余额清零

### 合约更改

#### RaceGame.tact

- 添加了 `prizePool` 和 `totalInvested` 状态变量
- `PlayerData` 结构体新增 `rewardBalance` 字段
- `buy_item` 函数现在会更新奖池和总投入
- 新增 `distributeRewards()` 函数用于分配奖金
- 新增 `withdraw_reward` 接收函数用于提取奖金
- 新增 `getPrizePool()` 和 `getTotalInvested()` getter函数

#### RaceGame.fc

- 更新了数据存储结构以包含奖池和总投入
- 更新了玩家数据结构以包含奖金余额
- 添加了提取功能的基础实现

### 前端更改

1. **UI新增**
   - 奖池信息显示区域
   - 奖金分配说明
   - 可提取奖金显示
   - 提取奖金按钮

2. **功能增强**
   - 实时显示当前奖池总额
   - 实时显示总投入金额
   - 显示玩家可提取的奖金余额
   - 提取奖金功能集成

3. **样式更新**
   - 新增奖池区域样式
   - 提取按钮样式
   - 奖金数值高亮显示

### 使用流程

1. **游戏进行中**
   - 玩家购买道具，资金存入奖池
   - 奖池总额实时更新
   - 总投入金额实时更新

2. **游戏结束**
   - 合约所有者调用 `end_game`
   - 自动计算排名
   - 自动分配奖金给前三名
   - 奖池清零（奖金已分配）

3. **提取奖金**
   - 玩家查看自己的奖金余额
   - 点击"提取奖金"按钮
   - 确认交易后，奖金发送到玩家钱包
   - 奖金余额清零

### 安全注意事项

1. **奖池安全**
   - 奖池资金存储在合约中
   - 只有游戏结束后才能分配
   - 分配后奖池立即清零

2. **提取安全**
   - 只能提取自己的奖金
   - 提取后余额立即清零
   - 防止重复提取

3. **数据一致性**
   - 所有资金操作都有状态跟踪
   - 玩家数据实时更新
   - 防止数据不一致

### 测试建议

1. 测试购买道具时奖池是否正确更新
2. 测试游戏结束后奖金是否正确分配
3. 测试提取功能是否正常工作
4. 测试多个玩家同时操作的情况
5. 测试边界情况（无玩家、只有1-2名玩家等）

### 后续优化建议

1. 添加事件日志以便前端监听
2. 添加提取历史记录
3. 支持部分提取功能
4. 添加提取手续费（可选）
5. 添加管理员提取功能（处理异常情况）

