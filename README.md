# F1 赛车竞速游戏 - TON链游

一个基于TON区块链的5分钟限时赛车竞速游戏。

## 游戏规则

1. **游戏时长**：每局游戏持续5分钟
2. **道具系统**：
   - 玩家可以购买随机道具（加速或减速）
   - 道具效果倍数：1X, 2X, 5X, 10X
   - 道具价格使用椭圆算法生成（购买越多，价格越高）
3. **获胜条件**：投入道具最多且正向效果最好的前三名获胜
4. **奖池系统**：
   - 所有购买道具的资金存入奖池
   - 游戏结束后，奖池按比例分配给前三名（50%/30%/20%）
   - 玩家可以随时提取自己的奖金

## 技术栈

- **智能合约**：Tact / FunC
- **前端**：HTML + CSS + JavaScript
- **钱包集成**：TON Connect

## 项目结构

```
gamebet/
├── contracts/          # 智能合约
│   ├── RaceGame.tact  # Tact版本合约
│   └── RaceGame.fc    # FunC版本合约
├── index.html         # 前端页面
├── styles.css         # 样式文件
├── app.js             # 前端逻辑
├── package.json       # 依赖配置
└── README.md          # 说明文档
```

## 安装和运行

### 前端应用

1. 进入前端目录：
```bash
cd frontend
npm install
```

2. 启动开发服务器：
```bash
npm run dev
```

3. 构建生产版本：
```bash
npm run build
npm start
```

### Telegram Bot

1. 进入 Bot 目录：
```bash
cd bot
npm install
```

2. 配置环境变量（复制 `.env.example` 为 `.env` 并填入配置）

3. 启动 Bot：
```bash
# 开发模式
npm run dev

# 生产模式
npm run build && npm start
```

详细说明请查看 [bot/README.md](./bot/README.md)

## 合约部署

1. 使用Tact编译器编译合约
2. 部署到TON测试网或主网
3. 更新 `app.js` 中的 `CONTRACT_ADDRESS`

## 椭圆算法说明

道具价格计算公式：
```
price = base_price * (1 + (item_count / max_items)^2)
```

其中：
- `base_price` = 1 TON (1e9 nanoTON)
- `max_items` = 1000
- `item_count` = 当前已购买的道具总数

随着购买道具数量增加，价格会按椭圆曲线上升。

## 功能特性

- ✅ 钱包连接（TON Connect）
- ✅ 游戏状态显示
- ✅ 实时倒计时
- ✅ 道具购买
- ✅ 椭圆算法价格计算
- ✅ 玩家数据展示
- ✅ 排行榜系统
- ✅ 三池资金分配系统（奖池/社区池/预留池）
- ✅ 可配置的分配比例（社区池最低20%）
- ✅ 自动奖金分配（前三名）
- ✅ 玩家奖金提取功能
- ✅ 社区池管理功能
- ✅ 实时显示各池余额和分配比例

## 资金分配系统

### 三池分配机制

购买道具时，资金按比例自动分配到三个池子：

- **🏆 奖池**（默认60%）：分配给每轮游戏的前三名
- **👥 社区池**（最低20%）：用于社区发展和运营
- **💎 预留池**（默认20%）：用于下一轮游戏的初始奖池

### 奖金分配规则
- 🥇 **第一名**：奖池的 50%
- 🥈 **第二名**：奖池的 30%
- 🥉 **第三名**：奖池的 20%

### 资金流程
1. **购买道具** → 资金按比例分配到三个池子
2. **游戏结束** → 自动计算排名
3. **自动分配奖金** → 奖池分配给前三名，存入玩家奖金余额
4. **新游戏开始** → 预留池资金转入奖池
5. **玩家提取** → 奖金发送到钱包

### 社区池管理
- 社区池占比必须 ≥ 20%（可配置）
- 只有合约所有者可以提取社区池资金
- 确保项目长期可持续发展

详细说明请查看 [FUND_DISTRIBUTION.md](./FUND_DISTRIBUTION.md)

### 提取奖金
- 玩家可以随时提取自己的奖金余额
- 提取后余额清零
- 支持多次提取（如果有多次游戏奖金）

## 注意事项

1. 需要准备F1赛车图片文件（car-red.png, car-neon.png 或使用SVG占位符）
2. 部署合约后需要更新合约地址
3. 需要配置TON Connect manifest文件
4. 确保合约有足够余额支付奖金提取
5. 游戏结束后需要调用 `end_game` 来分配奖金

