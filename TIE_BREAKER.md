# 平局处理机制文档

## 功能概述

当两个车的速度完全相同时（平局），游戏将没有获胜者，奖池不会分配给玩家，而是按比例分配给社区池和下一轮的预留池。

## 实现逻辑

### 平局检测

使用`getLeadingCar()`函数检测：
- 返回 `1`：Car1领先
- 返回 `2`：Car2领先
- 返回 `0`：平局（两个车速度相同）

### 平局处理

当检测到平局时（`leadingCar == 0`）：

1. **不计算排名**：跳过`calculateRanks()`函数
2. **不分配奖励**：跳过`distributeRewards()`函数
3. **奖池重新分配**：
   - 50%进入社区池
   - 50%进入预留池（下一轮游戏的初始奖池）

### 代码实现

```tact
// 结束游戏并计算排名
receive("end_game") {
    // ... 验证和状态更新 ...
    
    // 检查两个车是否平局
    let leadingCar: Int = self.getLeadingCar();
    
    if (leadingCar == 0) {
        // 平局：没有获胜者，奖池按比例进入社区池和预留池
        let pool = self.prizePool.toInt();
        // 50%给社区池，50%给预留池
        let communityAmount: Int = pool * 50 / 100;
        let reserveAmount: Int = pool - communityAmount;
        
        self.communityPool = self.communityPool + communityAmount.toCoins();
        self.reservePool = self.reservePool + reserveAmount.toCoins();
        self.prizePool = 0.toCoins();  // 清空奖池
        
        // 平局时不计算排名和分配奖励
    } else {
        // 有获胜者：正常计算排名和分配奖励
        self.calculateRanks();
        self.distributeRewards();
    }
}
```

## 分配比例

当前实现使用固定比例：
- **社区池**：50%
- **预留池**：50%

### 为什么这样分配？

1. **社区池（50%）**：
   - 用于运营和维护
   - 可以用于社区活动
   - 增加运营收益

2. **预留池（50%）**：
   - 作为下一轮游戏的初始奖池
   - 提高下一轮游戏的吸引力
   - 保持游戏连续性

## 使用场景

### 场景1：正常结束（有获胜者）

1. 游戏结束
2. 检测到有领先车辆（Car1或Car2）
3. 计算排名（前三名）
4. 分配奖励给前三名
5. 清空奖池

### 场景2：平局结束（无获胜者）

1. 游戏结束
2. 检测到平局（两个车速度相同）
3. **跳过排名计算**
4. **跳过奖励分配**
5. 将奖池按50/50分配给社区池和预留池
6. 清空奖池

## 前端显示

前端需要根据游戏结果显示不同的信息：

### 有获胜者时
- 显示前三名排行榜
- 显示奖励分配信息
- 显示获胜车辆

### 平局时
- 显示"平局！没有获胜者"
- 显示奖池已分配给社区池和预留池
- 不显示排行榜（或显示空排行榜）

## 优势

1. **公平性**：平局时所有玩家都不获得奖励，避免争议
2. **可持续性**：奖池资金不会浪费，进入社区池和预留池
3. **吸引力**：预留池增加下一轮游戏的初始奖池，提高吸引力
4. **运营收益**：社区池增加运营收益

## 注意事项

1. **平局检测时机**：在游戏结束时检测，确保最终速度
2. **精度问题**：速度计算使用整数，平局检测基于`currentSpeed`相等
3. **排名数据**：平局时`ranks`映射保持为空，前端需要处理这种情况

## 测试建议

1. **平局测试**：
   - 创建两个车速度完全相同的场景
   - 验证奖池是否正确分配给社区池和预留池
   - 验证排名是否为空

2. **正常结束测试**：
   - 创建有明确获胜者的场景
   - 验证排名和奖励分配是否正常

3. **边界测试**：
   - 测试速度差为1的情况（应该不是平局）
   - 测试速度完全相等的情况（应该是平局）

## 总结

平局处理机制确保了：
- ✅ 平局时没有获胜者
- ✅ 奖池按比例分配给社区池和预留池
- ✅ 保持游戏的公平性和可持续性
- ✅ 提高下一轮游戏的吸引力

