# 策略购买与返现系统文档

## 功能概述

策略购买系统允许玩家在购买道具时选择不同的策略，每种策略有不同的返现比例和价格优惠，增加游戏的策略性和玩家收益。

## 策略类型

### 1. 保守策略 🛡️ (Strategy 0)

**特点：**
- 返现：10%（最高）
- 价格：不变
- 适合：追求稳定返现的玩家

**计算：**
```
实际支付 = 基础价格
返现金额 = 实际支付 × 10%
```

**示例：**
- 基础价格：0.01 TON
- 实际支付：0.01 TON
- 返现金额：0.001 TON
- 净成本：0.009 TON

### 2. 平衡策略 ⚖️ (Strategy 1) - 默认

**特点：**
- 返现：5%（标准）
- 价格：不变
- 适合：大多数玩家，平衡返现和成本

**计算：**
```
实际支付 = 基础价格
返现金额 = 实际支付 × 5%
```

**示例：**
- 基础价格：0.01 TON
- 实际支付：0.01 TON
- 返现金额：0.0005 TON
- 净成本：0.0095 TON

### 3. 激进策略 ⚡ (Strategy 2)

**特点：**
- 返现：2%（最低）
- 价格：降低5%
- 适合：追求最低价格的玩家

**计算：**
```
实际支付 = 基础价格 × 95%
返现金额 = 实际支付 × 2%
```

**示例：**
- 基础价格：0.01 TON
- 实际支付：0.0095 TON（降低5%）
- 返现金额：0.00019 TON
- 净成本：0.00931 TON

### 4. 幸运策略 🍀 (Strategy 3)

**特点：**
- 返现：3%
- 价格：不变
- 特殊效果：10%概率获得双倍道具效果
- 适合：追求刺激和运气的玩家

**计算：**
```
实际支付 = 基础价格
返现金额 = 实际支付 × 3%
道具效果 = 基础效果 × (10%概率为2倍，90%概率为1倍)
```

**示例：**
- 基础价格：0.01 TON
- 实际支付：0.01 TON
- 返现金额：0.0003 TON
- 道具效果：10%概率为2X/4X/10X/20X，90%概率为1X/2X/5X/10X

## 合约实现

### 数据结构

#### BuyItemMessage 扩展
```tact
message BuyItemMessage {
    referrer: Address? as maybe<Address>;  // 可选的推荐人地址
    strategy: Int as int;  // 购买策略（0-3）
}
```

#### ItemEffect 扩展
```tact
message ItemEffect {
    itemId: Int as int;
    multiplier: Int as int;
    effectType: Int as int;
    effectValue: Int as int;
    strategy: Int as int;        // 使用的策略
    cashbackAmount: Int as coins; // 返现金额
    finalPrice: Int as coins;     // 实际支付价格
}
```

### 核心逻辑

#### 1. 策略价格计算
```tact
fun calculatePriceWithStrategy(basePrice: Int, strategy: Int): (Int, Int) {
    // 根据策略计算实际价格和返现
    // 返回：(实际支付价格, 返现金额)
}
```

#### 2. 购买道具流程
```tact
1. 计算基础价格
2. 根据策略计算实际价格和返现
3. 验证支付金额
4. 生成道具（幸运策略可能双倍效果）
5. 计算返现并加到玩家余额
6. 从净金额（实际支付-返现）中分配资金
```

#### 3. 返现机制
```tact
// 返现直接加到玩家的rewardBalance
let newRewardBalance = currentData.rewardBalance + cashbackAmount.toCoins();

// 返现从实际支付金额中扣除，不影响资金分配
let netAmount = finalPrice - cashbackAmount;
// 从netAmount中分配：奖池/社区池/预留池
```

### 配置参数

```tact
cashbackPercentConservative: Int = 10;  // 保守策略返现10%
cashbackPercentBalanced: Int = 5;       // 平衡策略返现5%
cashbackPercentAggressive: Int = 2;    // 激进策略返现2%
cashbackPercentLucky: Int = 3;         // 幸运策略返现3%
aggressivePriceDiscount: Int = 5;      // 激进策略价格折扣5%
```

## 前端实现

### 策略选择界面

1. **策略卡片**：
   - 显示策略图标、名称、描述
   - 显示返现比例和价格折扣
   - 选中状态高亮显示

2. **价格预览**：
   - 基础价格
   - 价格折扣（如果有）
   - 实际支付价格
   - 立即返现金额

3. **购买结果显示**：
   - 道具详情
   - 使用的策略
   - 实际支付金额
   - 返现金额
   - 提示：返现已添加到可提取余额

## 经济模型分析

### 返现对资金分配的影响

**场景：基础价格0.01 TON，使用平衡策略（5%返现）**

```
玩家支付：0.01 TON
返现金额：0.0005 TON（5%）
净金额：0.0095 TON（用于分配）

分配（75%/15%/10%）：
- 奖池：0.007125 TON（75%）
- 社区池：0.001425 TON（15%）
- 预留池：0.00095 TON（10%）
```

**影响：**
- ✅ 返现提高玩家满意度
- ✅ 返现从支付金额中扣除，不影响运营收益比例
- ⚠️ 但实际用于分配的资金减少（减少返现部分）

### 不同策略的净成本对比

| 策略 | 基础价格 | 实际支付 | 返现 | 净成本 | 适合场景 |
|------|---------|---------|------|--------|---------|
| 保守 | 0.01 TON | 0.01 TON | 0.001 TON | 0.009 TON | 追求稳定返现 |
| 平衡 | 0.01 TON | 0.01 TON | 0.0005 TON | 0.0095 TON | 大多数玩家 |
| 激进 | 0.01 TON | 0.0095 TON | 0.00019 TON | 0.00931 TON | 追求最低价格 |
| 幸运 | 0.01 TON | 0.01 TON | 0.0003 TON | 0.0097 TON | 追求刺激 |

## 优势分析

### 1. 增加策略深度 ⭐⭐⭐⭐

- ✅ 玩家需要选择策略
- ✅ 不同策略适合不同场景
- ✅ 增加游戏思考性

### 2. 提高玩家收益 ⭐⭐⭐⭐⭐

- ✅ 所有玩家都能获得返现
- ✅ 即使不获胜也有收益
- ✅ 提高玩家满意度

### 3. 增加游戏趣味性 ⭐⭐⭐⭐

- ✅ 幸运策略增加刺激感
- ✅ 策略选择增加参与感
- ✅ 返现增加获得感

### 4. 提升玩家留存 ⭐⭐⭐⭐

- ✅ 返现机制提高留存
- ✅ 策略选择增加粘性
- ✅ 即使失败也有收益

## 注意事项

### 1. 返现资金来源

返现从玩家支付金额中扣除，不影响运营收益比例，但实际用于分配的资金减少。

### 2. 资金平衡

需要确保返现机制不会导致资金不平衡：
- 返现总额 < 总投入
- 返现比例合理（2-10%）

### 3. 策略平衡

需要确保不同策略都有吸引力：
- 保守策略：高返现，适合稳定玩家
- 平衡策略：标准返现，适合大多数玩家
- 激进策略：低价格，适合价格敏感玩家
- 幸运策略：特殊效果，适合追求刺激的玩家

## 优化建议

### 1. 动态返现比例

根据游戏阶段调整返现比例：
- 初期：提高返现（吸引玩家）
- 稳定期：标准返现
- 成熟期：降低返现（提高运营收益）

### 2. 策略效果优化

- 增加更多策略类型
- 策略组合效果
- 策略升级系统

### 3. 返现活动

- 限时双倍返现
- 特定策略返现加成
- 返现排行榜

## 总结

策略购买与返现系统实现了：
- ✅ 策略选择机制（4种策略）
- ✅ 返现机制（2-10%返现）
- ✅ 幸运策略特殊效果（10%概率双倍）
- ✅ 提高玩家收益和满意度
- ✅ 增加游戏策略深度

这个系统显著提升了游戏的可玩性和玩家留存！

